# Integration Pipeline

End-to-end pipeline for compiling tests, running coverage, filtering/reducing
LLM-generated tests, and comparing adopted vs generated tests.

## Layout

- `run_integration_pipeline.sh` - main entrypoint
- `src/cli/` - Typer CLI entrypoints
- `src/pipeline/` - pipeline orchestration + shared pipeline helpers
- `src/steps/` - step implementations (each step class lives in this module)
- `src/core/` - shared helpers/utilities
- `src/metrics/` - PMD/CPD + tri-compare tooling
- `libs/` - Java dependencies for test execution
- `jacoco-deps/` - JaCoCo agent jar
- `coverage-filter-1.0-SNAPSHOT.jar` - CoverageFilterApp tool
- `build/` - compiled test classes (generated by the pipeline)
- `tmp/` - working area (logs, coverage exec files)
- `results/` - pipeline outputs (if used by your flow)

## Structure

Code organization and responsibilities:

- `src/pipeline/pipeline.py` - `Pipeline` class, target iteration, step dispatch
- `src/pipeline/config.py` - configuration, defaults, and config builder
- `src/pipeline/helpers.py` - pipeline-only helpers (paths, test discovery helpers)
- `src/steps/base.py` - `Step` abstract base class
- `src/steps/*.py` - concrete `{Name}Step` implementations colocated with their runtime helpers

## Quick start

From `integration_pipeline`:

```bash
./run_integration_pipeline.sh \
  ../_logs/tests_inventory.csv \
  ../../out/cut_to_fatjar_map.csv \
  all
```

CLI usage (direct):

```bash
python -m src [options...] <tests_inventory.csv> <cut_to_fatjar_map.csv> <command>
```

Examples:

```bash
python -m src <tests_inventory.csv> <cut_to_fatjar_map.csv> coverage compare-reduced --top-n 5
python -m src <tests_inventory.csv> <cut_to_fatjar_map.csv> adopted reduce --max-tests 5
```

## Steps

The CLI accepts a command argument (default: `all` in `run_integration_pipeline.sh`).
Some commands are grouped under subcommands: `llm`, `adopted`, and `coverage`.

Priority order (recommended run sequence):

1) `compile`
2) `run`
3) `filter`  
4) `reduce`  
5) `llm all`  
6) `llm improve`  
7) `llm integrate`  
8) `llm integrate-sbs`  
9) `agent`  
10) `adopted fix`  
11) `adopted comment`  
12) `adopted filter`  
13) `adopted reduce`  
14) `compare`  
15) `adopted run`  
16) `pull-request-maker`  
17) `coverage compare`  
18) `coverage compare-reduced`

Step descriptions:

- `compile` - compile generated and manual tests, resolve dependencies, and build test classpaths under `build/`.
- `run` - execute generated/manual tests with JaCoCo and write `results/coverage/coverage_summary.csv`.
- `filter` - run CoverageFilterApp to identify tests with coverage signal (uses fatjar + libs).
- `reduce` - create reduced generated tests (top-N, `--max-tests`) based on coverage deltas.
- `llm all` - send reduced tests + manual tests (promptType `integration_all`) to produce adopted tests. Subcommand: `llm all`.
- `llm improve` - send reduced tests only (promptType `integration_improvement`) to produce `_Improved` tests. Subcommand: `llm improve`.
- `llm integrate` - send `_Improved` tests + manual tests (promptType `integration_merge`) to produce adopted tests. Subcommand: `llm integrate`.
- `llm integrate-sbs` - send `_Improved` tests + manual tests (promptType `integration_step_by_step`) to produce `_Adopted_StepByStep` tests. Subcommand: `llm integrate-sbs`.
- `agent` - use Codex CLI to integrate `_Improved` tests with manual tests and output adopted tests (defaults to CLI model).
- `adopted fix` - normalize adopted tests (via `src/steps/fix.py`) by removing `_scaffolding` imports/extends and adding `throws Exception` to test methods. Subcommand: `adopted fix`.
- `adopted comment` - iteratively comment compile-error lines in `_Adopted` and `_Adopted_Agentic` tests until they compile. Subcommand: `adopted comment`.
- `adopted filter` - run CoverageFilterApp for `_Adopted` and `_Adopted_Agentic` tests against manual tests. Subcommand: `adopted filter`.
- `adopted reduce` - reduce `_Adopted` and `_Adopted_Agentic` tests (default top 5; `--max-tests`). Subcommand: `adopted reduce`.
- `compare` - compare adopted vs generated tests (PMD/CPD + tri-compare metrics).
- `adopted run` - execute adopted and agentic tests with JaCoCo and write `results/coverage/adopted_coverage_summary.csv`. Subcommand: `adopted run`.
- `pull-request-maker` - generate per-CUT PR drafts in `results/pr/` from `docs/PR_TEMPLATE.md`.
- `coverage compare` - compare coverage for manual/auto/adopted/agentic tests; writes `results/coverage/coverage_compare.csv`. Subcommand: `coverage compare`.
- `coverage compare-reduced` - compare coverage for reduced auto/adopted/agentic tests using a shared top-N (`--top-n`, default 5); writes `results/coverage/coverage_compare_reduced.csv`. Subcommand: `coverage compare-reduced`.
- `all` - run all steps in the priority order above.

## Inputs

- `tests_inventory.csv` (from collected tests)
- `cut_to_fatjar_map.csv` (from fatjar build)
- `libs/*` for JUnit and runtime deps
- `coverage-filter-1.0-SNAPSHOT.jar`
- `jacoco-deps/org.jacoco.agent-run-0.8.14.jar`
- adopted tests output root (`--adopted-dir`, default `results/llm-out`)
- Codex CLI must be installed and logged in for `agent` step
- Agent prompt guardrails: `--agent-max-prompt-chars` (default 60000)

## Outputs

- `build/` compiled test classes
- `tmp/` logs, coverage exec files, and summaries
  - `results/coverage/coverage_summary.csv`
  - `results/coverage/adopted_coverage_summary.csv`
- `results/` intermediate artifacts (covfilter/reduced/compare)
  - `results/covfilter/` (generated covfilter outputs)
  - `results/reduced-agt/` (reduced generated tests)
  - `results/covfilter-adopted/` (adopted covfilter outputs)
  - `results/reduced-adopted/` (reduced adopted tests)
  - `results/compare/` (comparison CSVs)
    - `results/compare/compare.csv`
    - `results/compare/tri_compare.csv`
  - `results/coverage/coverage_compare.csv`
  - `results/coverage/coverage_compare_reduced.csv`

## Notes

- The launcher uses `python -m src` and assumes
  module sources are in `src/`.
- Coverage summary CSVs are tracked in git; everything else under `tmp/`
  is ignored by default.
- Compare metrics documentation: `docs/COMPARE_METRICS.md`.
