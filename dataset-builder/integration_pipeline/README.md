# Integration Pipeline

End-to-end pipeline for compiling tests, running coverage, filtering/reducing
LLM-generated tests, and comparing adopted vs generated tests.

## Layout

- `run_integration_pipeline.sh` - main entrypoint
- `src/` - pipeline modules
- `libs/` - Java dependencies for test execution
- `jacoco-deps/` - JaCoCo agent jar
- `coverage-filter-1.0-SNAPSHOT.jar` - CoverageFilterApp tool
- `build/` - compiled test classes (generated by the pipeline)
- `jacoco-out/` - coverage outputs and logs
- `results/` - pipeline outputs (if used by your flow)

## Quick start

From `integration_pipeline`:

```bash
./run_integration_pipeline.sh \
  ../_logs/tests_inventory.csv \
  ../../out/cut_to_fatjar_map.csv \
  all
```

## Steps

The script accepts a step argument (default: `all`).

Priority order (recommended run sequence):

1) `compile`
2) `run`
3) `filter`  
4) `reduce`  
5) `llm-all`  
6) `llm-agt-improvement`  
7) `llm-integration`  
8) `llm-integration-step-by-step`  
9) `agent`  
10) `adopted-fix`  
11) `adopted-comment`  
12) `adopted-filter`  
13) `adopted-reduce`  
14) `compare`  
15) `adopted-run`

Step descriptions:

- `compile` - compile generated and manual tests, resolve dependencies, and build test classpaths under `build/`.
- `run` - execute generated/manual tests with JaCoCo and write `coverage_summary.csv`.
- `filter` - run CoverageFilterApp to identify tests with coverage signal (uses fatjar + libs).
- `reduce` - create reduced generated tests (top-N) based on coverage deltas.
- `llm-all` - send reduced tests + manual tests (promptType `integration_all`) to produce adopted tests.
- `llm-agt-improvement` - send reduced tests only (promptType `integration_improvement`) to produce `_Improved` tests.
- `llm-integration` - send `_Improved` tests + manual tests (promptType `integration_merge`) to produce adopted tests.
- `llm-integration-step-by-step` - send `_Improved` tests + manual tests (promptType `integration_step_by_step`) to produce `_Adopted_StepByStep` tests.
- `agent` - use Codex CLI to integrate `_Improved` tests with manual tests and output adopted tests (defaults to CLI model).
- `adopted-fix` - normalize adopted tests (via `src/pipeline_fix.py`) by removing `_scaffolding` imports/extends and adding `throws Exception` to test methods.
- `adopted-comment` - iteratively comment compile-error lines in `_Adopted` and `_Adopted_Agentic` tests until they compile.
- `adopted-filter` - run CoverageFilterApp for `_Adopted` and `_Adopted_Agentic` tests against manual tests.
- `adopted-reduce` - reduce `_Adopted` and `_Adopted_Agentic` tests (default top 5; `--adopted-reduce-max-tests`).
- `compare` - compare adopted vs generated tests (PMD/CPD + tri-compare metrics).
- `adopted-run` - execute adopted tests with JaCoCo and write `adopted_coverage_summary.csv`.
- `all` - run all steps in the priority order above.

## Inputs

- `tests_inventory.csv` (from collected tests)
- `cut_to_fatjar_map.csv` (from fatjar build)
- `libs/*` for JUnit and runtime deps
- `coverage-filter-1.0-SNAPSHOT.jar`
- `jacoco-deps/org.jacoco.agent-run-0.8.14.jar`
- adopted tests output root (`--adopted-dir`, default `results/llm-out`)
- Codex CLI must be installed and logged in for `agent` step
- Agent prompt guardrails: `--agent-max-prompt-chars` (default 60000)

## Outputs

- `build/` compiled test classes
- `tmp/` logs, coverage exec files, and summaries
  - `tmp/coverage_summary.csv`
  - `tmp/adopted_coverage_summary.csv`
- `result/` intermediate artifacts (covfilter/reduced/compare)
  - `result/covfilter/` (generated covfilter outputs)
  - `result/reduced-agt/` (reduced generated tests)
- `result/covfilter-adopted/` (adopted covfilter outputs)
- `result/reduced-adopted/` (reduced adopted tests)
  - `result/compare/` (comparison CSVs)

## Notes

- The launcher uses `python -m integration_pipeline.pipeline_main` and assumes
  module sources are in `src/`.
- Coverage summary CSVs are tracked in git; everything else under `tmp/`
  is ignored by default.
